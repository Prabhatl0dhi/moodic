<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moodic - Results</title>
  <style>
    body {
      background: linear-gradient(to bottom right, #121212, #1DB954);
      color: white;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    h1 {
      margin-top: 40px;
      font-size: 2.5rem;
    }

    .tracks-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 30px;
      gap: 20px;
      padding: 0 20px;
    }

    .track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      width: 250px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(8px);
    }

    .track img {
      width: 100%;
      border-radius: 12px;
    }

    .track h3 {
      margin: 10px 0 5px;
      font-size: 1.2rem;
    }

    .track p {
      margin: 0 0 10px;
      font-size: 0.95rem;
      color: #ccc;
    }

    audio {
      width: 100%;
      outline: none;
    }

    .error {
      color: red;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Your Mood-Based Playlist ðŸŽµ</h1>
  <div id="error" class="error"></div>
  <div class="tracks-container" id="tracksContainer"></div>

  <script>
    // Get token and moods from sessionStorage or URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token') || sessionStorage.getItem("token");
    const moods = JSON.parse(sessionStorage.getItem("selectedMoods") || "[]");

    if (!token || moods.length === 0) {
      document.getElementById("error").innerText = "Missing token or moods. Please go back.";
    } else {
      // Save token for future use
      sessionStorage.setItem("token", token);

      fetch("https://moodic-backend.onrender.com/recommend", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, moods })
      })
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("tracksContainer");
        if (data.error || !data.tracks) {
          document.getElementById("error").innerText = "Something went wrong. Try again.";
          return;
        }

        if (data.tracks.length === 0) {
          container.innerHTML = "<p>No tracks found for the selected mood(s).</p>";
          return;
        }

        data.tracks.forEach(track => {
          const div = document.createElement("div");
          div.className = "track";
          div.innerHTML = `
            <img src="${track.image}" alt="${track.name}">
            <h3>${track.name}</h3>
            <p>${track.artist}</p>
            ${track.preview_url ? `<audio controls src="${track.preview_url}"></audio>` : "<p>No preview available</p>"}
          `;
          container.appendChild(div);
        });
      })
      .catch(err => {
        document.getElementById("error").innerText = "Network error. Please try again.";
        console.error(err);
      });
    }
  </script>
</body>
</html>
